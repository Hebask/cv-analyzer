<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CV Analyzer</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>CV Analyzer</h1>
      <p>Upload a PDF CV → Extract (OCR fallback) → Analyze & score (strict JSON).</p>

      <div class="grid">
        <div>
          <label class="label">User ID</label>
          <input id="userId" placeholder="e.g. u123" value="u123" />
        </div>

        <div>
          <label class="label">CV PDF</label>
          <input id="pdfFile" type="file" accept="application/pdf" />
        </div>
      </div>

      <div class="row">
        <button id="btnUpload">1) Upload & Extract</button>
        <div style="flex:1"></div>
        <div class="badge">
          <div class="k">cv_id</div>
          <div class="v" id="cvId">—</div>
        </div>
      </div>

      <div id="uploadSection" class="section" style="display:none;">
        <h3>Upload Result</h3>
        <div class="row" style="margin-top:0;">
          <div class="pill" id="sourcePill">text_source: —</div>
          <div class="pill">chars: <span id="extractedChars" style="margin-left:6px;">—</span></div>
        </div>
        <div class="preview" id="extractedPreview"></div>
      </div>

      <hr />

      <div class="section">
        <h3>Requirements Builder</h3>

        <div class="grid">
          <div>
            <label class="label">Target Role</label>
            <input id="roleInput" placeholder="e.g. Research Assistant (Pharmaceutics)" />
          </div>

          <div>
            <label class="label">Quick presets</label>
            <div class="row" style="margin-top:0;">
              <button class="btn-secondary" id="btnPresetGeneral">General</button>
              <button class="btn-secondary" id="btnPresetResearch">Research (Pharmaceutics)</button>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="chip-area">
            <div class="row" style="margin-top:0;">
              <div style="font-weight:600;">Must-have</div>
              <div class="small">(press Enter to add)</div>
            </div>
            <div class="chip-input-row">
              <input id="mustInput" placeholder="e.g. HPLC" />
              <button class="btn-secondary" id="mustAdd">Add</button>
            </div>
            <div class="chips" id="mustChips"></div>
          </div>

          <div class="chip-area">
            <div class="row" style="margin-top:0;">
              <div style="font-weight:600;">Nice-to-have</div>
              <div class="small">(press Enter to add)</div>
            </div>
            <div class="chip-input-row">
              <input id="niceInput" placeholder="e.g. Nanoparticles" />
              <button class="btn-secondary" id="niceAdd">Add</button>
            </div>
            <div class="chips" id="niceChips"></div>
          </div>
        </div>

        <div class="section weights">
          <div class="row" style="margin-top:0; justify-content:space-between;">
            <div>
              <div style="font-weight:600;">Weights</div>
              <div class="small">Move sliders (we auto-normalize to sum = 1.0)</div>
            </div>
            <div class="pill" id="sumPill">sum: 1.000</div>
          </div>

          <div class="weight-row">
            <div class="weight-name">Relevance to role</div>
            <input type="range" min="0" max="100" value="30" id="w_relevance"/>
            <div class="weight-value" id="v_relevance">0.300</div>
          </div>

          <div class="weight-row">
            <div class="weight-name">Skills match</div>
            <input type="range" min="0" max="100" value="30" id="w_skills"/>
            <div class="weight-value" id="v_skills">0.300</div>
          </div>

          <div class="weight-row">
            <div class="weight-name">Experience strength</div>
            <input type="range" min="0" max="100" value="20" id="w_experience"/>
            <div class="weight-value" id="v_experience">0.200</div>
          </div>

          <div class="weight-row">
            <div class="weight-name">Education fit</div>
            <input type="range" min="0" max="100" value="10" id="w_education"/>
            <div class="weight-value" id="v_education">0.100</div>
          </div>

          <div class="weight-row">
            <div class="weight-name">Clarity & structure</div>
            <input type="range" min="0" max="100" value="10" id="w_clarity"/>
            <div class="weight-value" id="v_clarity">0.100</div>
          </div>

          <div class="row">
            <button class="btn-secondary" id="btnResetWeights">Reset weights</button>
            <button class="btn-secondary" id="btnCopyReq">Copy requirements JSON</button>
          </div>
        </div>

        <div class="row">
          <button id="btnAnalyze">2) Analyze & Score</button>
          <div class="small" id="builderStatus">—</div>
        </div>
      </div>

      <div id="errorBox" class="error" style="display:none;"></div>

      <div id="resultSection" class="section" style="display:none;">
  <h3>Result</h3>

  <div class="grid">
    <div class="chip-area">
      <div class="row" style="margin-top:0; justify-content:space-between;">
        <div>
          <div style="font-weight:700; font-size:16px;">Overall fit</div>
          <div class="small" id="fitLabel">—</div>
        </div>
        <div class="pill ok" id="scorePill">Score: —</div>
      </div>

      <div class="preview" id="fitSummary" style="max-height:none;">—</div>
    </div>

    <div class="chip-area">
      <div style="font-weight:700; font-size:16px;">Candidate</div>
      <div class="small" id="candHeadline">—</div>

      <div class="kv"><div class="k">Name</div><div class="v" id="candName">—</div></div>
      <div class="kv"><div class="k">Email</div><div class="v" id="candEmail">—</div></div>
      <div class="kv"><div class="k">Phone</div><div class="v" id="candPhone">—</div></div>
      <div class="kv"><div class="k">Location</div><div class="v" id="candLocation">—</div></div>
      <div class="kv"><div class="k">Links</div><div class="v" id="candLinks">—</div></div>
    </div>
  </div>

  <div class="grid section">
    <div class="chip-area">
      <div class="row" style="margin-top:0;">
        <div style="font-weight:700;">Skills match</div>
        <div class="small" id="skillsMeta">—</div>
      </div>

      <div class="row">
        <div class="pill ok">Matched</div>
      </div>
      <div class="chips" id="matchedSkills"></div>

      <div class="row">
        <div class="pill warn">Missing (from must-have)</div>
      </div>
      <div class="chips" id="missingSkills"></div>
    </div>

    <div class="chip-area">
      <div style="font-weight:700;">Strengths & gaps</div>
      <div class="preview" id="strengthsGaps" style="max-height:none;">—</div>
    </div>
  </div>

  <div class="grid section">
    <div class="chip-area">
      <div style="font-weight:700;">Experience</div>
      <div class="preview" id="experienceBlock" style="max-height:none;">—</div>
    </div>

    <div class="chip-area">
      <div style="font-weight:700;">Education</div>
      <div class="preview" id="educationBlock" style="max-height:none;">—</div>
    </div>
  </div>

  <div class="section">
    <div class="kv"><div class="k">analysis_id</div><div class="v" id="analysisId" style="font-family:ui-monospace,monospace">—</div></div>

    <details style="margin-top:10px;">
      <summary style="cursor:pointer;">Advanced (JSON)</summary>
      <pre id="fullJson"></pre>
    </details>
  </div>
</div>

    </div>
  </div>

<script>
  const API_BASE = "http://127.0.0.1:8000";
  const el = (id) => document.getElementById(id);

  const userIdEl = el("userId");
  const fileEl = el("pdfFile");
  const btnUpload = el("btnUpload");
  const cvIdEl = el("cvId");

  const uploadSection = el("uploadSection");
  const sourcePill = el("sourcePill");
  const extractedCharsEl = el("extractedChars");
  const extractedPreviewEl = el("extractedPreview");

  const roleInput = el("roleInput");
  const btnPresetGeneral = el("btnPresetGeneral");
  const btnPresetResearch = el("btnPresetResearch");

  const mustInput = el("mustInput");
  const mustAdd = el("mustAdd");
  const mustChipsEl = el("mustChips");

  const niceInput = el("niceInput");
  const niceAdd = el("niceAdd");
  const niceChipsEl = el("niceChips");

  const w_relevance = el("w_relevance");
  const w_skills = el("w_skills");
  const w_experience = el("w_experience");
  const w_education = el("w_education");
  const w_clarity = el("w_clarity");

  const v_relevance = el("v_relevance");
  const v_skills = el("v_skills");
  const v_experience = el("v_experience");
  const v_education = el("v_education");
  const v_clarity = el("v_clarity");

  const sumPill = el("sumPill");
  const btnResetWeights = el("btnResetWeights");
  const btnCopyReq = el("btnCopyReq");
  const btnAnalyze = el("btnAnalyze");
  const builderStatus = el("builderStatus");

  const errorBox = el("errorBox");
  const resultSection = el("resultSection");
  const overallScoreEl = el("overallScore");
  const analysisIdEl = el("analysisId");
  const fullJsonEl = el("fullJson");

  let currentCvId = "";
  let mustHave = [];
  let niceToHave = [];

  function setError(msg){
    if(!msg){
      errorBox.style.display = "none";
      errorBox.textContent = "";
      return;
    }
    errorBox.style.display = "block";
    errorBox.textContent = "Error: " + msg;
  }

  function setBusy(isBusy){
    btnUpload.disabled = isBusy;
    btnAnalyze.disabled = isBusy;

    btnUpload.textContent = isBusy ? "Working..." : "1) Upload & Extract";
    btnAnalyze.textContent = isBusy ? "Working..." : "2) Analyze & Score";
  }

  function normalizeWeights(){
    const raws = [
      +w_relevance.value,
      +w_skills.value,
      +w_experience.value,
      +w_education.value,
      +w_clarity.value
    ];

    const sum = raws.reduce((a,b)=>a+b,0);

    if(sum === 0){
      w_relevance.value = 30;
      w_skills.value = 30;
      w_experience.value = 20;
      w_education.value = 10;
      w_clarity.value = 10;
      return normalizeWeights();
    }

    const norm = raws.map(x => x / sum);

    v_relevance.textContent = norm[0].toFixed(3);
    v_skills.textContent = norm[1].toFixed(3);
    v_experience.textContent = norm[2].toFixed(3);
    v_education.textContent = norm[3].toFixed(3);
    v_clarity.textContent = norm[4].toFixed(3);

    const normSum = norm.reduce((a,b)=>a+b,0);
    sumPill.textContent = "sum: " + normSum.toFixed(3);
    sumPill.className = "pill ok";

    return {
      relevance_to_role: +norm[0].toFixed(3),
      skills_match: +norm[1].toFixed(3),
      experience_strength: +norm[2].toFixed(3),
      education_fit: +norm[3].toFixed(3),
      clarity_and_structure: +norm[4].toFixed(3),
    };
  }

  function renderChips(list, container){
    container.innerHTML = "";
    list.forEach((item, idx) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `
        <span>${escapeHtml(item)}</span>
        <button title="Remove">×</button>
      `;
      chip.querySelector("button").addEventListener("click", () => {
        list.splice(idx, 1);
        renderAllChips();
        updateBuilderStatus();
      });
      container.appendChild(chip);
    });
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function addChip(list, value){
    const v = (value || "").trim();
    if(!v) return false;

    const exists = list.some(x => x.toLowerCase() === v.toLowerCase());
    if(exists) return false;

    list.push(v);
    return true;
  }

  function renderAllChips(){
    renderChips(mustHave, mustChipsEl);
    renderChips(niceToHave, niceChipsEl);
  }

  function buildRequirements(){
    const weights = normalizeWeights();
    const role = (roleInput.value || "").trim() || "General";

    return {
      role,
      must_have: mustHave.slice(),
      nice_to_have: niceToHave.slice(),
      weights
    };
  }

  function updateBuilderStatus(){
    const req = buildRequirements();
    builderStatus.textContent =
      `Role: "${req.role}" | Must-have: ${req.must_have.length} | Nice-to-have: ${req.nice_to_have.length}`;
  }

  function applyPreset(preset){
    roleInput.value = preset.role;
    mustHave = preset.must_have.slice();
    niceToHave = preset.nice_to_have.slice();

    const w = preset.weights;
    w_relevance.value = Math.round((w.relevance_to_role || 0.25) * 100);
    w_skills.value = Math.round((w.skills_match || 0.25) * 100);
    w_experience.value = Math.round((w.experience_strength || 0.25) * 100);
    w_education.value = Math.round((w.education_fit || 0.15) * 100);
    w_clarity.value = Math.round((w.clarity_and_structure || 0.10) * 100);

    renderAllChips();
    normalizeWeights();
    updateBuilderStatus();
  }

  const PRESET_GENERAL = {
    role: "General",
    must_have: [],
    nice_to_have: [],
    weights: {
      relevance_to_role: 0.25,
      skills_match: 0.25,
      experience_strength: 0.25,
      education_fit: 0.15,
      clarity_and_structure: 0.10
    }
  };

  const PRESET_RESEARCH = {
    role: "Research Assistant (Pharmaceutics)",
    must_have: ["Formulation", "Drug Delivery", "HPLC", "Cell culture"],
    nice_to_have: ["Nanoparticles", "Inhalable delivery", "GraphPad Prism"],
    weights: {
      relevance_to_role: 0.30,
      skills_match: 0.30,
      experience_strength: 0.20,
      education_fit: 0.10,
      clarity_and_structure: 0.10
    }
  };

  applyPreset(PRESET_RESEARCH);

  [w_relevance, w_skills, w_experience, w_education, w_clarity].forEach(sl => {
    sl.addEventListener("input", () => {
      normalizeWeights();
      updateBuilderStatus();
    });
  });

  btnResetWeights.addEventListener("click", () => {
    applyPreset({ ...buildRequirements(), weights: PRESET_RESEARCH.weights });
  });

  btnCopyReq.addEventListener("click", async () => {
    const req = buildRequirements();
    const txt = JSON.stringify(req, null, 2);
    try {
      await navigator.clipboard.writeText(txt);
      builderStatus.textContent = "Copied requirements JSON ✅";
      setTimeout(updateBuilderStatus, 1200);
    } catch {
      // fallback
      prompt("Copy requirements JSON:", txt);
    }
  });

  // Events: chips
  mustAdd.addEventListener("click", () => {
    if(addChip(mustHave, mustInput.value)){
      mustInput.value = "";
      renderAllChips();
      updateBuilderStatus();
    }
  });
  niceAdd.addEventListener("click", () => {
    if(addChip(niceToHave, niceInput.value)){
      niceInput.value = "";
      renderAllChips();
      updateBuilderStatus();
    }
  });

  mustInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      mustAdd.click();
    }
  });
  niceInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      niceAdd.click();
    }
  });

  btnPresetGeneral.addEventListener("click", () => applyPreset(PRESET_GENERAL));
  btnPresetResearch.addEventListener("click", () => applyPreset(PRESET_RESEARCH));

  btnUpload.addEventListener("click", async () => {
    setError("");
    resultSection.style.display = "none";

    const user_id = userIdEl.value.trim();
    const file = fileEl.files?.[0];

    if(!user_id) return setError("Please enter user_id.");
    if(!file) return setError("Please choose a PDF file.");

    const form = new FormData();
    form.append("user_id", user_id);
    form.append("file", file);

    setBusy(true);
    try {
      const res = await fetch(API_BASE + "/cv/upload", {
        method: "POST",
        body: form
      });

      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Upload failed");

      currentCvId = data.id;
      cvIdEl.textContent = currentCvId;

      uploadSection.style.display = "block";
      sourcePill.textContent = "text_source: " + (data.text_source || "—");
      sourcePill.className = "pill " + (data.text_source === "ocr" ? "warn" : "ok");

      extractedCharsEl.textContent = data.extracted_chars ?? "—";
      extractedPreviewEl.textContent = data.extracted_preview || "";

    } catch (e) {
      setError(e.message);
    } finally {
      setBusy(false);
    }
  });
  function scoreToLabel(score){
  if(score >= 85) return {label:"Excellent match", cls:"ok"};
  if(score >= 70) return {label:"Good match", cls:"ok"};
  if(score >= 55) return {label:"Partial match", cls:"warn"};
  return {label:"Low match", cls:"warn"};
}

function safe(obj, path, fallback="—"){
  try{
    return path.split(".").reduce((acc,k)=>acc?.[k], obj) ?? fallback;
  } catch { return fallback; }
}

function normalizeList(x){
  if(!x) return [];
  if(Array.isArray(x)) return x.filter(Boolean).map(String);
  return [String(x)];
}

function makeChip(text, type="ok"){
  const d = document.createElement("div");
  d.className = "chip";
  d.style.borderColor = type==="warn" ? "var(--warnLine)" : "var(--okLine)";
  d.style.background = type==="warn" ? "var(--warn)" : "var(--ok)";
  d.innerHTML = `<span>${escapeHtml(text)}</span>`;
  return d;
}

function renderChipList(container, items, type){
  container.innerHTML = "";
  if(!items.length){
    container.appendChild(makeChip("—", "warn"));
    return;
  }
  items.forEach(s => container.appendChild(makeChip(s, type)));
}

// Reuse your existing escapeHtml()
function escapeHtml(str){
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function buildLinksHtml(linksObj){
  if(!linksObj || typeof linksObj !== "object") return "—";
  const entries = Object.entries(linksObj).filter(([_,v]) => v && String(v).trim());
  if(!entries.length) return "—";
  return entries.map(([k,v]) => {
    const url = String(v).startsWith("http") ? String(v) : "https://" + String(v);
    return `<a href="${escapeHtml(url)}" target="_blank">${escapeHtml(k)}</a>`;
  }).join(" · ");
}

function renderHumanReport(payload){
  // payload = { analysis_id, overall_score, analysis }
  const score = payload.overall_score ?? 0;
  const {label, cls} = scoreToLabel(score);

  // elements
  const resultSection = document.getElementById("resultSection");
  const analysisIdEl = document.getElementById("analysisId");
  const fullJsonEl = document.getElementById("fullJson");

  const scorePill = document.getElementById("scorePill");
  const fitLabel = document.getElementById("fitLabel");
  const fitSummary = document.getElementById("fitSummary");

  const candHeadline = document.getElementById("candHeadline");
  const candName = document.getElementById("candName");
  const candEmail = document.getElementById("candEmail");
  const candPhone = document.getElementById("candPhone");
  const candLocation = document.getElementById("candLocation");
  const candLinks = document.getElementById("candLinks");

  const matchedSkillsEl = document.getElementById("matchedSkills");
  const missingSkillsEl = document.getElementById("missingSkills");
  const skillsMeta = document.getElementById("skillsMeta");

  const strengthsGaps = document.getElementById("strengthsGaps");
  const experienceBlock = document.getElementById("experienceBlock");
  const educationBlock = document.getElementById("educationBlock");

  const analysis = payload.analysis || {};

  // Set header
  resultSection.style.display = "block";
  analysisIdEl.textContent = payload.analysis_id ?? "—";
  fullJsonEl.textContent = JSON.stringify(analysis, null, 2);

  scorePill.textContent = `Score: ${score}`;
  scorePill.className = `pill ${cls}`;
  fitLabel.textContent = label;

  // Candidate section (try multiple schema shapes safely)
  const name =
    safe(analysis, "candidate.name", "") ||
    safe(analysis, "candidate.full_name", "") ||
    safe(analysis, "profile.name", "—");

  const email =
    safe(analysis, "candidate.email", "") ||
    safe(analysis, "candidate.contacts.email", "") ||
    safe(analysis, "contacts.email", "—");

  const phone =
    safe(analysis, "candidate.phone", "") ||
    safe(analysis, "candidate.contacts.phone", "") ||
    safe(analysis, "contacts.phone", "—");

  const location =
    safe(analysis, "candidate.location", "") ||
    safe(analysis, "candidate.address", "") ||
    safe(analysis, "location", "—");

  const links =
    analysis.candidate?.links ||
    analysis.links ||
    analysis.candidate?.socials ||
    null;

  const headline =
    safe(analysis, "summary.headline", "") ||
    safe(analysis, "summary", "") ||
    safe(analysis, "profile.headline", "—");

  candHeadline.textContent = headline || "—";
  candName.textContent = name || "—";
  candEmail.textContent = email || "—";
  candPhone.textContent = phone || "—";
  candLocation.textContent = location || "—";
  candLinks.innerHTML = buildLinksHtml(links);

  // Summary / strengths / gaps
  const strengths =
    normalizeList(safe(analysis, "match.strengths", null))
    .concat(normalizeList(safe(analysis, "strengths", null)));

  const gaps =
    normalizeList(safe(analysis, "match.gaps", null))
    .concat(normalizeList(safe(analysis, "gaps", null)));

  const reco =
    normalizeList(safe(analysis, "recommendations", null))
    .concat(normalizeList(safe(analysis, "match.recommendations", null)));

  fitSummary.textContent =
    (safe(analysis, "summary_text", "") ||
     safe(analysis, "summary.headline", "") ||
     safe(analysis, "summary", "")) ||
    "—";

  strengthsGaps.textContent =
    `Strengths:\n- ${strengths.length ? strengths.join("\n- ") : "—"}\n\n` +
    `Gaps:\n- ${gaps.length ? gaps.join("\n- ") : "—"}\n\n` +
    `Recommendations:\n- ${reco.length ? reco.join("\n- ") : "—"}`;

  // Skills match (compare builder must-have against extracted skills)
  // Extract skills from analysis (support multiple possible fields)
  const extractedSkills =
    normalizeList(safe(analysis, "skills.hard_skills", null))
    .concat(normalizeList(safe(analysis, "skills.soft_skills", null)))
    .concat(normalizeList(safe(analysis, "skills.mandatory", null)))
    .concat(normalizeList(safe(analysis, "skills", null)));

  // You have these arrays in your builder script:
  // mustHave, niceToHave (global)
  const must = (typeof mustHave !== "undefined") ? mustHave : [];
  const nice = (typeof niceToHave !== "undefined") ? niceToHave : [];

  const extractedLower = new Set(extractedSkills.map(s => s.toLowerCase()));
  const matched = [...must, ...nice].filter(s => extractedLower.has(s.toLowerCase()));
  const missing = must.filter(s => !extractedLower.has(s.toLowerCase()));

  skillsMeta.textContent = `Extracted skills: ${extractedSkills.length} | Matched: ${matched.length} | Missing must-have: ${missing.length}`;
  renderChipList(matchedSkillsEl, matched, "ok");
  renderChipList(missingSkillsEl, missing, "warn");

  // Experience & Education blocks (best-effort rendering)
  const exp =
    analysis.experience ||
    analysis.work_experience ||
    analysis.employment_history ||
    [];

  const edu =
    analysis.education ||
    analysis.academics ||
    [];

  const expArr = Array.isArray(exp) ? exp : [];
  const eduArr = Array.isArray(edu) ? edu : [];

  experienceBlock.textContent = expArr.length
    ? expArr.map((e, i) => {
        const title = e.title || e.position || e.role || "Role";
        const org = e.company || e.organization || e.employer || "";
        const dates = e.dates || [e.start_date, e.end_date].filter(Boolean).join(" → ");
        const bullets = normalizeList(e.bullets || e.achievements || e.responsibilities);
        return `${i+1}) ${title}${org ? " — " + org : ""}${dates ? " ("+dates+")" : ""}\n   - ${bullets.length ? bullets.join("\n   - ") : "—"}`;
      }).join("\n\n")
    : "—";

  educationBlock.textContent = eduArr.length
    ? eduArr.map((e, i) => {
        const deg = e.degree || e.program || "Degree";
        const inst = e.institution || e.university || "";
        const year = e.year || e.graduation_year || "";
        const extra = [e.gpa ? "GPA: " + e.gpa : "", e.field ? "Field: " + e.field : ""].filter(Boolean).join(" | ");
        return `${i+1}) ${deg}${inst ? " — " + inst : ""}${year ? " ("+year+")" : ""}${extra ? "\n   " + extra : ""}`;
      }).join("\n\n")
    : "—";
}


  btnAnalyze.addEventListener("click", async () => {
    setError("");
    if(!currentCvId) return setError("cv_id is missing. Upload a CV first.");

    const requirements = buildRequirements();

    setBusy(true);
    try {
      const res = await fetch(API_BASE + "/cv/analyze", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ cv_id: currentCvId, requirements })
      });

      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail || "Analyze failed");

      renderHumanReport(data);

    } catch (e) {
      setError(e.message);
    } finally {
      setBusy(false);
    }
  });

  updateBuilderStatus();
</script>
</body>
</html>
